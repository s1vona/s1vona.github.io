<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Sivona">





<title>2020网鼎杯 | Hexo</title>



    <link rel="icon" href="/ida.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    




<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Sivona&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Sivona&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">2020网鼎杯</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Sivona</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">May 11, 2020&nbsp;&nbsp;12:03:14</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/writeup/">writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="jocker"><a href="#jocker" class="headerlink" title="jocker"></a>jocker</h3><p>因为sp有负数，ida无法反编译出main伪代码，可以用ALT+K在两个sp错误的地方修改sp为0</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text</span>:<span class="number">00401788</span> loc_401788:                             <span class="comment">; CODE XREF: _main+54↑j</span></span><br><span class="line"><span class="symbol">.text</span>:<span class="number">00401788</span>                 lea     eax, [ebp+var_96]</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">0040178</span>E                 <span class="keyword">mov </span>    [esp+<span class="number">4</span>], eax</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">00401792</span>                 <span class="keyword">mov </span>    dword ptr [esp], offset a40s <span class="comment">; "%40s"</span></span><br><span class="line"><span class="symbol">.text</span>:<span class="number">00401799</span>                 call    _scanf</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">0040179</span>E                 lea     eax, [ebp+var_96]</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span><span class="built_in">A4</span>                 <span class="keyword">mov </span>    [esp], eax      <span class="comment">; char *</span></span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span>A7                 call    _strlen</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span>AC                 <span class="keyword">mov </span>    [ebp+var_10], eax</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span>AF                 <span class="keyword">cmp </span>    [ebp+var_10], <span class="number">18</span>h</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span>B3                 jz      short loc_4017CD</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span>B5                 <span class="keyword">mov </span>    dword ptr [esp], offset aWrong <span class="comment">; "Wrong!"</span></span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span>BC                 call    _puts</span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span><span class="built_in">C1</span>                 <span class="keyword">mov </span>    dword ptr [esp], <span class="number">0</span> <span class="comment">; int</span></span><br><span class="line"><span class="symbol">.text</span>:<span class="number">004017</span><span class="built_in">C8</span>                 call    _exit</span><br></pre></td></tr></table></figure>
<p>经过输入并判断长度后进入wrong函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__cdecl <span class="title">wrong</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i &amp; <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = &amp;a1[i];</span><br><span class="line">      a1[i] -= i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      result = &amp;a1[i];</span><br><span class="line">      a1[i] ^= i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再进入omg函数对一堆byte进行比较</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">omg</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v2[<span class="number">24</span>]; <span class="comment">// [esp+18h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+78h] [ebp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+7Ch] [ebp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">1</span>;</span><br><span class="line">  qmemcpy(v2, &amp;dword_4030C0, <span class="keyword">sizeof</span>(v2));</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a1[i] != v2[i] )</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"hahahaha_do_you_find_me?"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"wrong ~~ But seems a little program"</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.data:<span class="number">004030</span>C0 dword_4030C0    dd <span class="number">66</span>h, <span class="number">6B</span>h, <span class="number">63</span>h, <span class="number">64</span>h, <span class="number">7F</span>h, <span class="number">61</span>h, <span class="number">67</span>h, <span class="number">64</span>h, <span class="number">3B</span>h, <span class="number">56</span>h, <span class="number">6B</span>h; <span class="number">0</span></span><br><span class="line">.data:<span class="number">004030</span>C0                                         ; DATA XREF: omg(<span class="keyword">char</span> *)+<span class="number">16</span>↑o</span><br><span class="line">.data:<span class="number">004030</span>C0                 dd <span class="number">61</span>h, <span class="number">7B</span>h, <span class="number">26</span>h, <span class="number">3B</span>h, <span class="number">50</span>h, <span class="number">63</span>h, <span class="number">5F</span>h, <span class="number">4</span>Dh, <span class="number">5</span>Ah, <span class="number">71</span>h, <span class="number">0</span>Ch; <span class="number">11</span></span><br><span class="line">.data:<span class="number">004030</span>C0                 dd <span class="number">37</span>h, <span class="number">66</span>h, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>; <span class="number">22</span></span><br><span class="line"><span class="comment">//这里将其转换成double word 再转换成数组</span></span><br></pre></td></tr></table></figure>
<p>这里得到一个假的flag</p>
<p>flag{fak3_alw35_sp_me!!}</p>
<p>当时高兴半天，感觉终于做出来一题，提交了半天发现后面还有函数</p>
<p><img src="https://s1.ax1x.com/2020/05/11/YGr7uQ.png" alt=""></p>
<p>这里对encrypt 和 final函数进行解密，这里应该也是导致sp错误的原因，我们动态调试</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00401500</span> <span class="title">| 55                       |</span> <span class="keyword">push </span>ebp                                <span class="title">|</span></span><br><span class="line"><span class="title">00401501 |</span> <span class="number">89</span>E5                     <span class="title">| mov ebp,esp                             |</span></span><br><span class="line"><span class="number">00401503</span> <span class="title">| 57                       |</span> <span class="keyword">push </span>edi                                <span class="title">|</span></span><br><span class="line"><span class="title">00401504 |</span> <span class="number">56</span>                       <span class="title">| push esi                                |</span> </span><br><span class="line"><span class="number">00401505</span> <span class="title">| 53                       |</span> <span class="keyword">push </span>ebx                                <span class="title">|</span></span><br><span class="line"><span class="title">00401506 |</span> <span class="number">83</span>EC <span class="number">7</span>C                  <span class="title">| sub esp,7C                              |</span></span><br><span class="line"><span class="number">00401509</span> <span class="title">| C745 E0 01000000         |</span> <span class="keyword">mov </span>dword ptr ss:[ebp-<span class="number">20</span>],<span class="number">1</span>             <span class="title">|</span></span><br><span class="line"><span class="title">00401510 |</span> <span class="number">8</span>D45 <span class="number">94</span>                  <span class="title">| lea eax,dword ptr ss:[ebp-6C]           |</span></span><br><span class="line"><span class="number">00401513</span> <span class="title">| BB 40304000              |</span> <span class="keyword">mov </span>ebx,jocker.<span class="number">403040</span>                   <span class="title">|</span></span><br><span class="line"><span class="title">00401518 |</span> <span class="keyword">BA </span><span class="number">13000000</span>              <span class="title">| mov edx,13                              |</span></span><br><span class="line"><span class="number">0040151</span>D <span class="title">| 89C7                     |</span> <span class="keyword">mov </span>edi,eax                             <span class="title">|</span></span><br><span class="line"><span class="title">0040151F |</span> <span class="number">89</span>DE                     <span class="title">| mov esi,ebx                             |</span> </span><br><span class="line"><span class="number">00401521</span> <span class="title">| 89D1                     |</span> <span class="keyword">mov </span>ecx,edx                             <span class="title">|</span></span><br><span class="line"><span class="title">00401523 |</span> <span class="built_in">F3</span>:A5                    <span class="title">| rep movsd                               |</span></span><br><span class="line"><span class="number">00401525</span> <span class="title">| C745 E4 00000000         |</span> <span class="keyword">mov </span>dword ptr ss:[ebp-<span class="number">1</span>C],<span class="number">0</span>             <span class="title">|</span></span><br><span class="line"><span class="title">0040152C |</span> EB <span class="number">49</span>                    <span class="title">| jmp jocker.401577                       |</span></span><br><span class="line"><span class="number">0040152</span>E <span class="title">| 8B55 E4                  |</span> <span class="keyword">mov </span>edx,dword ptr ss:[ebp-<span class="number">1</span>C]           <span class="title">|</span></span><br><span class="line"><span class="title">00401531 |</span> <span class="number">8</span>B45 <span class="number">08</span>                  <span class="title">| mov eax,dword ptr ss:[ebp+8]            |</span> </span><br><span class="line"><span class="number">00401534</span> <span class="title">| 01D0                     |</span> <span class="keyword">add </span>eax,edx                             <span class="title">|</span></span><br><span class="line"><span class="title">00401536 |</span> <span class="number">0</span>FB610                   <span class="title">| movzx edx,byte ptr ds:[eax]             |</span></span><br><span class="line"><span class="number">00401539</span> <span class="title">| 8B45 E4                  |</span> <span class="keyword">mov </span>eax,dword ptr ss:[ebp-<span class="number">1</span>C]           <span class="title">|</span></span><br><span class="line"><span class="title">0040153C |</span> <span class="number">05</span> <span class="number">12404000</span>              <span class="title">| add eax,jocker.404012                   |</span> <span class="number">404012</span>:<span class="string">"hahahaha_do_you_find_me?"</span></span><br><span class="line"><span class="number">00401541</span> <span class="title">| 0FB600                   |</span> <span class="keyword">movzx </span>eax,<span class="keyword">byte </span>ptr ds:[eax]             <span class="title">|</span></span><br><span class="line"><span class="title">00401544 |</span> <span class="number">31</span><span class="built_in">D0</span>                     <span class="title">| xor eax,edx                             |</span></span><br><span class="line"><span class="number">00401546</span> <span class="title">| 0FBED0                   |</span> <span class="keyword">movsx </span>edx,al                            <span class="title">|</span></span><br><span class="line"><span class="title">00401549 |</span> <span class="number">8</span>B45 E4                  <span class="title">| mov eax,dword ptr ss:[ebp-1C]           |</span></span><br><span class="line"><span class="number">0040154</span>C <span class="title">| 8B4485 94                |</span> <span class="keyword">mov </span>eax,dword ptr ss:[ebp+eax*<span class="number">4</span>-<span class="number">6</span>C]     <span class="title">|</span></span><br><span class="line"><span class="title">00401550 |</span> <span class="number">39</span><span class="built_in">C2</span>                     <span class="title">| cmp edx,eax                             |</span></span><br><span class="line"><span class="number">00401552</span> <span class="title">| 74 1F                    |</span> je jocker.<span class="number">401573</span>                        <span class="title">|</span></span><br><span class="line"><span class="title">00401554 |</span> C70424 <span class="number">00404000</span>          <span class="title">| mov dword ptr ss:[esp],jocker.404000    |</span> <span class="number">404000</span>:<span class="string">"wrong ~"</span></span><br><span class="line"><span class="number">0040155</span>B <span class="title">| E8 E0130000              |</span> call &lt;JMP.&amp;puts&gt;                        <span class="title">|</span></span><br><span class="line"><span class="title">00401560 |</span> C745 E0 <span class="number">00000000</span>         <span class="title">| mov dword ptr ss:[ebp-20],0             |</span></span><br><span class="line"><span class="number">00401567</span> <span class="title">| C70424 00000000          |</span> <span class="keyword">mov </span>dword ptr ss:[esp],<span class="number">0</span>                <span class="title">|</span></span><br><span class="line"><span class="title">0040156E |</span> E8 AD130000              <span class="title">| call &lt;JMP.&amp;exit&gt;                        |</span></span><br><span class="line"><span class="number">00401573</span> <span class="title">| 8345 E4 01               |</span> <span class="keyword">add </span>dword ptr ss:[ebp-<span class="number">1</span>C],<span class="number">1</span>             <span class="title">|</span></span><br><span class="line"><span class="title">00401577 |</span> <span class="number">837</span>D E4 <span class="number">12</span>               <span class="title">| cmp dword ptr ss:[ebp-1C],12            |</span></span><br><span class="line"><span class="number">0040157</span>B <span class="title">| 7E B1                    |</span> jle jocker.<span class="number">40152</span>E                       <span class="title">|</span></span><br><span class="line"><span class="title">0040157D |</span> <span class="number">837</span>D E0 <span class="number">01</span>               <span class="title">| cmp dword ptr ss:[ebp-20],1             |</span></span><br><span class="line"><span class="number">00401581</span> <span class="title">| 75 0C                    |</span> jne jocker.<span class="number">40158</span>F                       <span class="title">|</span></span><br><span class="line"><span class="title">00401583 |</span> C70424 <span class="number">08404000</span>          <span class="title">| mov dword ptr ss:[esp],jocker.404008    |</span> <span class="number">404008</span>:<span class="string">"come here"</span></span><br><span class="line"><span class="number">0040158</span>A <span class="title">| E8 B1130000              |</span> call &lt;JMP.&amp;puts&gt;                        <span class="title">|</span></span><br><span class="line"><span class="title">0040158F |</span> <span class="number">8</span>B45 E0                  <span class="title">| mov eax,dword ptr ss:[ebp-20]           |</span></span><br><span class="line"><span class="number">00401592</span> <span class="title">| 83C4 7C                  |</span> <span class="keyword">add </span>esp,<span class="number">7</span>C                              <span class="title">|</span></span><br><span class="line"><span class="title">00401595 |</span> <span class="number">5</span>B                       <span class="title">| pop ebx                                 |</span></span><br><span class="line"><span class="number">00401596</span> <span class="title">| 5E                       |</span> <span class="keyword">pop </span>esi                                 <span class="title">| </span></span><br><span class="line"><span class="title">00401597 |</span> <span class="number">5</span>F                       <span class="title">| pop edi                                 |</span></span><br><span class="line"><span class="number">00401598</span> <span class="title">| 5D                       |</span> <span class="keyword">pop </span>ebp                                 <span class="title">|</span></span><br><span class="line"><span class="title">00401599 |</span> <span class="built_in">C3</span>                       <span class="title">| ret                                     |</span></span><br></pre></td></tr></table></figure>

<p>大概意思是输入的字符串前19个字符和hahahaha_do_you_find_me?进行异或然后和[0Eh, 0Dh, 9, 6, 13h, 5, 58h, 56h, 3Eh, 6, 0Ch, 3Ch,1Fh, 57h, 14h, 6Bh, 57h, 59h, 0Dh]比较</p>
<p>这里得到flag的前19位flag{d07abccf8a410c</p>
<p>最后这个函数当时怎么也没搞懂，应该是%tp&amp;:和flag{进行比较，但是只比较了第一个(如果我没看错的话），’}’和’:’异或得到’G’，用这个去异或%tp&amp;得到b37a}，完整flag：flag{d07abccf8a410cb37a}</p>
<p>修改sp后main函数的伪代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [esp+12h] [ebp-96h]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+44h] [ebp-64h]</span></span><br><span class="line">  DWORD flOldProtect; <span class="comment">// [esp+94h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">size_t</span> v7; <span class="comment">// [esp+98h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+9Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  __main();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"please input you flag:"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( VirtualProtect(encrypt, <span class="number">0xC8</span>u, <span class="number">4u</span>, &amp;flOldProtect) == <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%40s"</span>, &amp;v4);</span><br><span class="line">  v7 = <span class="built_in">strlen</span>(&amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( v7 != <span class="number">24</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(&amp;v5, &amp;v4);</span><br><span class="line">  wrong(&amp;v4);</span><br><span class="line">  omg(&amp;v4);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">186</span>; ++i )</span><br><span class="line">    *((_BYTE *)encrypt + i) ^= <span class="number">0x41</span>u;</span><br><span class="line">  <span class="keyword">if</span> ( encrypt(&amp;v5) != <span class="number">0</span> )</span><br><span class="line">    finally(&amp;v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="使用idapython脚本解密函数查看伪代码"><a href="#使用idapython脚本解密函数查看伪代码" class="headerlink" title="使用idapython脚本解密函数查看伪代码"></a>使用idapython脚本解密函数查看伪代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">en = <span class="number">0x00401500</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xbb</span>):</span><br><span class="line">	addr = en + i</span><br><span class="line">	byte = get_bytes(addr,<span class="number">1</span>)</span><br><span class="line">	byte = ord(byte)^<span class="number">0x41</span></span><br><span class="line">	patch_byte(addr,byte)</span><br></pre></td></tr></table></figure>

<p>点击ida中的File-&gt;Script file…加载此脚本</p>
<p>然后在encrypto函数中使用U快捷键undefined掉原来所有数据，再使用P快捷键重新生成函数。</p>
<p>当然也可以用ida动态调试后查看伪代码</p>
<h3 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>看了一些师傅的wp说这个是伪虚拟机的逆向，让本菜鸡不禁想问 啥是虚拟机？？？</p>
<p>vm_operad函数里的switch我看着都头疼，比赛时就没有仔细看，其实从后往前分析逻辑还是比较简单的</p>
<p>当case 7时会进行判断，我们可以看到a1后半段的数据都是7后面再跟一个数，也就是v4经过一段加密然后和这个数比较，v4是在case 1时被赋值的，根据a1的一堆数据我们可以发现，我们的输入的每个字符会在1之前的几个case进行加密，从7后面的数据往前推就可以得到正确的输入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">v3[<span class="number">0</span>] = (<span class="number">0x22</span>+<span class="number">5</span>) ^ <span class="number">0x10</span></span><br><span class="line">v3[<span class="number">1</span>] = int(<span class="number">0x3f</span>/<span class="number">3</span>) ^ <span class="number">0x20</span></span><br><span class="line">v3[<span class="number">2</span>] = <span class="number">0x37</span></span><br><span class="line">v3[<span class="number">3</span>] = (<span class="number">0x32</span>^<span class="number">4</span>) <span class="number">-1</span> </span><br><span class="line">v3[<span class="number">4</span>] = int((<span class="number">0x72</span>+<span class="number">0x21</span>)/<span class="number">3</span>)</span><br><span class="line">v3[<span class="number">5</span>] = <span class="number">0x35</span></span><br><span class="line">v3[<span class="number">6</span>] = (<span class="number">0x18</span>+<span class="number">0x20</span>) ^ <span class="number">9</span></span><br><span class="line">v3[<span class="number">7</span>] = (<span class="number">0xa7</span> ^ <span class="number">0x24</span>) - <span class="number">0x51</span></span><br><span class="line">v3[<span class="number">8</span>] = <span class="number">0x31</span></span><br><span class="line">v3[<span class="number">9</span>] = int((<span class="number">0xf1</span><span class="number">-0x25</span>)/<span class="number">2</span>)</span><br><span class="line">v3[<span class="number">10</span>] = (<span class="number">0x28</span> ^ <span class="number">0x41</span>) <span class="number">-0x36</span></span><br><span class="line">v3[<span class="number">11</span>] = <span class="number">0x84</span> - <span class="number">0x20</span></span><br><span class="line">v3[<span class="number">12</span>] = int((<span class="number">0xc1</span><span class="number">-0x25</span>)/<span class="number">3</span>)</span><br><span class="line">v3[<span class="number">13</span>] = (<span class="number">0x1e</span>+<span class="number">0x20</span>) ^ <span class="number">9</span></span><br><span class="line">v3[<span class="number">14</span>] = (<span class="number">0x7a</span><span class="number">-1</span>)<span class="number">-0x41</span></span><br></pre></td></tr></table></figure>

<p>如何快速得到那一堆数据呢</p>
<p>先将其转换为array 再点击Edit-&gt;Export data 或者快捷键shift+e</p>
<p><img src="https://s1.ax1x.com/2020/05/13/YwwjtH.png" alt=""></p>
<h4 id="方法二-符号执行"><a href="#方法二-符号执行" class="headerlink" title="方法二 符号执行"></a>方法二 符号执行</h4><p>使用ida插件ponce <a href="https://github.com/illera88/Ponce" target="_blank" rel="noopener">https://github.com/illera88/Ponce</a></p>
<p>在scanf后下断点 将我们的输入符号化</p>
<p>在ida7.0下没有复现成功，所以换了ida6.8 需要注意的是 在hex dump中无法symbolize memory 但是可以在反汇编视图中进行这个操作</p>
<p><img src="https://s1.ax1x.com/2020/05/13/YdNnkn.png" alt=""></p>
<p><img src="https://s1.ax1x.com/2020/05/13/YdN2tI.png" alt=""></p>
<p>之后修改eip的值为0x4016FE防止程序退出，然后继续F9执行，重复上图的操作，得到剩下的值</p>
<p>使用angr</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">'./signal.exe'</span>)   <span class="comment">#指定angr跑的程序</span></span><br><span class="line">state = p.factory.entry_state()    <span class="comment">#新建一个SimState的对象，得到一个初始化到二进制入口函数的SimState对象。</span></span><br><span class="line">simgr = p.factory.simgr(state)   <span class="comment">#创建simulation manager，angr的主要入口</span></span><br><span class="line"></span><br><span class="line">simgr.explore(find=<span class="number">0x004017A5</span> ,avoid=<span class="number">0x004016E6</span>)  <span class="comment">#争取跑到输出成功的地址，避免跑到输出wrong的地址</span></span><br><span class="line">flag = simgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>)[:<span class="number">15</span>]     <span class="comment">#得到flag</span></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>



<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="boom2"><a href="#boom2" class="headerlink" title="boom2"></a>boom2</h3><p>先开一下开了什么保护</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>运行一下，提示输出code</p>
<p>丢到ida里面，代码都在main函数里</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"MC execution system\nInput your code&gt; "</span>, <span class="number">0L</span>L, a2, a1);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x120</span>uLL);</span><br><span class="line">v3 += <span class="number">0x8000</span>;</span><br><span class="line">v37 = v3;                                     <span class="comment">// 栈底</span></span><br><span class="line">--v3;</span><br><span class="line">*v3 = <span class="number">0x1E</span>LL;                                 <span class="comment">// [bp-1] = 30</span></span><br><span class="line">--v3;</span><br><span class="line">*v3 = <span class="number">0xD</span>LL;                                  <span class="comment">// [bp-2] = 13</span></span><br><span class="line">v4 = v3;</span><br><span class="line">--v3;</span><br><span class="line">*v3 = v5 - <span class="number">1</span>;                                 <span class="comment">// [bp-3] = 0</span></span><br><span class="line">--v3;</span><br><span class="line">*v3 = v6 + <span class="number">8</span>;                                 <span class="comment">// [bp-4] = 真实栈中的地址</span></span><br><span class="line">v36 = v3 - <span class="number">1</span>;</span><br><span class="line">*v36 = (<span class="keyword">signed</span> __int64)v4;                    <span class="comment">// [bp-5] = bp-2</span></span><br><span class="line">v39 = <span class="number">0L</span>L;</span><br></pre></td></tr></table></figure>

<p>这段代码之后是一堆while(1)，比赛的时候看到这一堆while(1)，直接把ida关掉了。。</p>
<p>其实这就是一个庞大的switch结构，也就是vm pwn，从输入里读取opcode。</p>
<p>第一个while读取opcode并限制只能输入30个code，随后的每一个while都是一个handler</p>
<p>对于vm类的题，搞清楚变量的含义是十分重要的</p>
<p>我们大概可以把这个当作一个栈结构，v36当作栈顶，v37当作栈底</p>
<p>[bp-4]处保存了真实的栈地址，我们可以尝试利用它去做文章，通过main函数的返回地址__libc_start_main+240 leak libc，将one_gadget覆盖到main函数返回地址</p>
<p>大概写一下每个handler的功能，凑合看吧。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0	v38 &#x3D; v37+[buf+1]</span><br><span class="line">1	v38 &#x3D; [buf+1]</span><br><span class="line">6	[v36-1] &#x3D; v37----v37 &#x3D; v36-1----sp &#x3D; sp-[buf+1]</span><br><span class="line">8	v37 &#x3D; *v37---sp &#x3D; v37+2-----[buf+1] &#x3D; [v37+1]-----</span><br><span class="line">9	v38 &#x3D; (dword)v38</span><br><span class="line">10	v38 &#x3D; (byte)v38</span><br><span class="line">11	**v36 &#x3D; v38----v36+&#x3D;8</span><br><span class="line">12	**v36byte &#x3D; v38----v36+&#x3D;4</span><br><span class="line">13	v36-&#x3D;8---[v36] &#x3D; v38</span><br><span class="line">14	v38 |&#x3D; [v36]---v36+&#x3D;8</span><br><span class="line">15	v38 ^&#x3D; [v36]---v36+&#x3D;8</span><br><span class="line">16	v38 &amp;&#x3D; [v36]---v36+&#x3D;8</span><br><span class="line">17	v38 &#x3D; [v36]&#x3D;&#x3D;v38---v36+&#x3D;8</span><br><span class="line">18	v38 &#x3D; [v36]!&#x3D;v38---v36+&#x3D;8</span><br><span class="line">19	v38 &#x3D; [v36] &lt; v38---v36+&#x3D;8</span><br><span class="line">20	v38 &#x3D; [v36] &gt; v38---v36+&#x3D;8</span><br><span class="line">21	v38 &#x3D; [v36] &lt;&#x3D; v38---v36+&#x3D;8</span><br><span class="line">22	v38 &#x3D; [v36] &gt;&#x3D; v38---v36+&#x3D;8</span><br><span class="line">23	v38 &#x3D; [v36] &lt;&lt; v38---v36+&#x3D;8</span><br><span class="line">24	v38 &#x3D; [v36] &gt;&gt; v38---v36+&#x3D;8</span><br><span class="line">25	v38 +&#x3D; [v36]---v36+&#x3D;8</span><br><span class="line">26	v38 &#x3D; [v36] - v38---v36+&#x3D;8</span><br><span class="line">27	v38 *&#x3D; [v36] ---v36+&#x3D;8</span><br><span class="line">28	v38 &#x3D; [v36] &#x2F;&#x2F; v38---v36+&#x3D;8</span><br><span class="line">29	v38 &#x3D; [v36] % v38---v36+&#x3D;8</span><br><span class="line">30	quit</span><br></pre></td></tr></table></figure>

<p>构造opcode：</p>
<p>16(v38=0)—1 0xe8—26(v38 = ret)—13—13—13—9—13—1 libc.sym[“__libc_start_main”] + 240—26—13—1 one_gadget—25(v38 = one_gadget)—11—30</p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="https://www.cnblogs.com/jentleTao/p/" target="_blank" rel="noopener">https://www.cnblogs.com/jentleTao/p/</a></p>
<p><a href="https://www.52pojie.cn/thread-1176826-1-1.html" target="_blank" rel="noopener">https://www.52pojie.cn/thread-1176826-1-1.html</a></p>
<p><a href="https://blog.csdn.net/Breeze_CAT/article/details/106078982" target="_blank" rel="noopener">https://blog.csdn.net/Breeze_CAT/article/details/106078982</a></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"787cc455593c1fb9cfcd","clientSecret":"f6abba3d9cc77878426ee16aa8bcb980fd3cd70c","repo":"s1vona.github.io","owner":"s1vona","admin":["s1vona"],"distractionFreeMode":true};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Sivona</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/wdb/"># wdb</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/05/15/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/">虚拟机逆向学习</a>
            
            
            <a class="next" rel="next" href="/2020/04/22/2018%E7%BD%91%E9%BC%8E%E6%9D%AFpwn/">2018网鼎杯pwn</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Sivona | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
    <div>
        友情链接: 
       <div>
        <a class="theme-link"  href="https://sncker.github.io" target="_blank" rel="noopener"> SNCKER's blog </a><span>&nbsp;&nbsp;</span>
        <a class="theme-link"  href="https://blog.csdn.net/qq_43531895" target="_blank" rel="noopener"> EnJoy_July 's blog' </a><span>&nbsp;&nbsp;</span>
       </div>
       
      </div>
</footer>

    </div>
</body>
</html>
